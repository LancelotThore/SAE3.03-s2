import * as JSC from "jscharting";
import { M } from "./js/model.js";
import { V } from "./js/view.js";

await M.init();

let all = [...M.getEvents("mmi1"), ...M.getEvents('mmi2'), ...M.getEvents("mmi3")]
console.log(all)

function renderTimes(events) {
    console.log(events)

    var chart = JSC.chart('chartDiv', {
        debug: true,
        type: 'horizontal',
        xAxis: {
            crosshair_enabled: true,
            scale: { type: 'time' }
        },
        legend_visible: false,
        defaultSeries: {
            type: 'line',
            firstPoint_label_text: '<b>%seriesName</b>',
            defaultPoint_marker: {
                type: 'circle',
                outline: { width: 2, color: 'white' }
            }
        },
        title_label_text: 'Date de fin des cours par jour',
        yAxis: { formatString: 'c' },
        series: [
            {
                name: 'BUT1 - G1',
                points: [
                    ['9/5/2023', 17.0],
                    ['9/6/2023', 18.0],
                    ['9/7/2023', 19.0],
                    ['9/8/2023', 18.0],
                    ['9/11/2023', 17.5],
                    ['9/12/2023', 19.0],
                    ['9/13/2023', 17.5],
                    ['9/14/2023', 18.0],
                    ['9/15/2023', 19.0],
                    ['9/18/2023', 16.5],
                    ['9/19/2023', 18.0],
                    ['9/20/2023', 17.5],
                    ['9/21/2023', 19.0],
                    ['9/22/2023', 18.5],
                    ['9/25/2023', 17.5],
                    ['9/26/2023', 18.0],
                    ['9/27/2023', 19.0],
                    ['9/28/2023', 16.5],
                    ['9/29/2023', 18.5],
                    ['10/2/2023', 17.0],
                    ['10/3/2023', 18.0],
                    ['10/4/2023', 19.0],
                    ['10/5/2023', 17.5],
                    ['10/6/2023', 18.0],
                    ['10/9/2023', 19.0],
                    ['10/10/2023', 16.5],
                    ['10/11/2023', 18.0],
                    ['10/12/2023', 17.5],
                    ['10/13/2023', 19.0],
                    ['10/16/2023', 18.5],
                    ['10/17/2023', 17.5],
                    ['10/18/2023', 18.0],
                    ['10/19/2023', 19.0],
                    ['10/20/2023', 17.0],
                    ['10/23/2023', 18.5],
                    ['10/24/2023', 17.5],
                    ['10/25/2023', 18.0],
                    ['10/26/2023', 19.0],
                    ['10/27/2023', 16.5],
                    ['10/30/2023', 18.0],
                    ['10/31/2023', 17.5],
                    ['11/1/2023', 18.0],
                    ['11/2/2023', 19.0],
                    ['11/3/2023', 17.5],
                    ['11/6/2023', 18.5],
                    ['11/7/2023', 17.5],
                    ['11/8/2023', 18.0],
                    ['11/9/2023', 19.0],
                    ['11/10/2023', 16.5],
                    ['11/13/2023', 18.0],
                    ['11/14/2023', 17.5],
                    ['11/15/2023', 18.0],
                    ['11/16/2023', 19.0],
                    ['11/17/2023', 17.5],
                    ['11/20/2023', 18.5],
                    ['11/21/2023', 17.5],
                    ['11/22/2023', 18.0],
                    ['11/23/2023', 19.0],
                    ['11/24/2023', 16.5],
                    ['11/27/2023', 18.0],
                    ['11/28/2023', 17.5],
                    ['11/29/2023', 18.0],
                    ['11/30/2023', 19.0],
                    ['12/1/2023', 17.5],
                    ['12/4/2023', 18.5],
                    ['12/5/2023', 17.5],
                    ['12/6/2023', 18.0],
                    ['12/7/2023', 19.0],
                    ['12/8/2023', 16.5],
                    ['12/11/2023', 18.0],
                    ['12/12/2023', 17.5],
                    ['12/13/2023', 18.0],
                    ['12/14/2023', 19.0],
                    ['12/15/2023', 17.5],
                    ['12/18/2023', 18.5],
                    ['12/19/2023', 17.5],
                    ['12/20/2023', 18.0],
                    ['12/21/2023', 19.0],
                    ['12/22/2023', 16.5],
                    ['12/25/2023', 18.0],
                    ['12/26/2023', 17.5],
                    ['12/27/2023', 18.0],
                    ['12/28/2023', 19.0],
                    ['12/29/2023', 17.5],
                    ['1/1/2024', 18.5],
                    ['1/2/2024', 17.5],
                    ['1/3/2024', 18.0],
                    ['1/4/2024', 19.0],
                    ['1/5/2024', 17.5],
                    ['1/8/2024', 18.5],
                    ['1/9/2024', 17.5],
                    ['1/10/2024', 18.0],
                    ['1/11/2024', 19.0],
                    ['1/12/2024', 17.5],
                    ['1/15/2024', 18.5],
                    ['1/16/2024', 17.5],
                    ['1/17/2024', 18.0],
                    ['1/18/2024', 19.0],
                    ['1/19/2024', 17.5],
                    ['1/22/2024', 18.0],
                    ['1/23/2024', 17.5],
                    ['1/24/2024', 18.0],
                    ['1/25/2024', 19.0],
                    ['1/26/2024', 17.5],
                    ['1/29/2024', 18.5],
                    ['1/30/2024', 17.5],
                    ['1/31/2024', 18.0],
                    ['2/1/2024', 19.0],
                    ['2/2/2024', 17.5],
                    ['2/5/2024', 18.0],
                    ['2/6/2024', 17.5],
                    ['2/7/2024', 18.0],
                    ['2/8/2024', 19.0],
                    ['2/9/2024', 17.5],
                    ['2/12/2024', 18.5],
                    ['2/13/2024', 17.5],
                    ['2/14/2024', 18.0],
                    ['2/15/2024', 19.0],
                    ['2/16/2024', 17.5],
                    ['2/19/2024', 18.0],
                    ['2/20/2024', 17.5],
                    ['2/21/2024', 18.0],
                    ['2/22/2024', 19.0],
                    ['2/23/2024', 17.5],
                    ['2/26/2024', 18.5],
                    ['2/27/2024', 17.5],
                    ['2/28/2024', 18.0],
                    ['2/29/2024', 19.0],
                    ['3/1/2024', 17.5]
                ]
            },
            {
                name: 'BUT1 - G21',
                points: [
                    ['9/5/2023', 16.5],
                    ['9/6/2023', 17.0],
                    ['9/7/2023', 19.0],
                    ['9/8/2023', 18.0],
                    ['9/11/2023', 17.5],
                    ['9/12/2023', 18.5],
                    ['9/13/2023', 16.5],
                    ['9/14/2023', 19.0],
                    ['9/15/2023', 18.0],
                    ['9/18/2023', 17.0],
                    ['9/19/2023', 18.5],
                    ['9/20/2023', 16.5],
                    ['9/21/2023', 18.0],
                    ['9/22/2023', 19.0],
                    ['9/25/2023', 18.0],
                    ['9/26/2023', 17.5],
                    ['9/27/2023', 16.5],
                    ['9/28/2023', 19.0],
                    ['9/29/2023', 17.0],
                    ['10/2/2023', 18.0],
                    ['10/3/2023', 17.5],
                    ['10/4/2023', 16.5],
                    ['10/5/2023', 18.5],
                    ['10/6/2023', 19.0],
                    ['10/9/2023', 17.0],
                    ['10/10/2023', 16.5],
                    ['10/11/2023', 18.5],
                    ['10/12/2023', 17.0],
                    ['10/13/2023', 19.0],
                    ['10/16/2023', 18.0],
                    ['10/17/2023', 17.5],
                    ['10/18/2023', 16.5],
                    ['10/19/2023', 18.0],
                    ['10/20/2023', 19.0],
                    ['10/23/2023', 17.0],
                    ['10/24/2023', 16.5],
                    ['10/25/2023', 18.5],
                    ['10/26/2023', 17.0],
                    ['10/27/2023', 19.0],
                    ['10/30/2023', 18.0],
                    ['10/31/2023', 16.5],
                    ['11/1/2023', 17.5],
                    ['11/2/2023', 18.0],
                    ['11/3/2023', 19.0],
                    ['11/6/2023', 17.0],
                    ['11/7/2023', 18.5],
                    ['11/8/2023', 16.5],
                    ['11/9/2023', 17.5],
                    ['11/10/2023', 18.0],
                    ['11/13/2023', 19.0],
                    ['11/14/2023', 16.5],
                    ['11/15/2023', 17.5],
                    ['11/16/2023', 18.0],
                    ['11/17/2023', 19.0],
                    ['11/20/2023', 17.0],
                    ['11/21/2023', 18.0],
                    ['11/22/2023', 16.5],
                    ['11/23/2023', 17.5],
                    ['11/24/2023', 18.5],
                    ['11/27/2023', 17.0],
                    ['11/28/2023', 18.0],
                    ['11/29/2023', 16.5],
                    ['11/30/2023', 17.5],
                    ['12/1/2023', 19.0],
                    ['12/4/2023', 18.0],
                    ['12/5/2023', 17.5],
                    ['12/6/2023', 16.5],
                    ['12/7/2023', 17.5],
                    ['12/8/2023', 18.5],
                    ['12/11/2023', 17.0],
                    ['12/12/2023', 18.0],
                    ['12/13/2023', 16.5],
                    ['12/14/2023', 17.5],
                    ['12/15/2023', 18.5],
                    ['12/18/2023', 17.0],
                    ['12/19/2023', 16.5],
                    ['12/20/2023', 18.5],
                    ['12/21/2023', 17.0],
                    ['12/22/2023', 19.0],
                    ['12/25/2023', 18.0],
                    ['12/26/2023', 18.0],
                    ['12/27/2023', 16.5],
                    ['12/28/2023', 17.0],
                    ['12/29/2023', 18.5],
                    ['1/1/2024', 17.5],
                    ['1/2/2024', 19.0],
                    ['1/3/2024', 18.0],
                    ['1/4/2024', 17.5],
                    ['1/5/2024', 16.5],
                    ['1/8/2024', 17.0],
                    ['1/9/2024', 18.5],
                    ['1/10/2024', 17.5],
                    ['1/11/2024', 16.5],
                    ['1/12/2024', 18.0],
                    ['1/15/2024', 17.5],
                    ['1/16/2024', 18.0],
                    ['1/17/2024', 16.5],
                    ['1/18/2024', 17.0],
                    ['1/19/2024', 19.0],
                    ['1/22/2024', 18.5],
                    ['1/23/2024', 17.0],
                    ['1/24/2024', 16.5],
                    ['1/25/2024', 18.0],
                    ['1/26/2024', 17.5],
                    ['1/29/2024', 19.0],
                    ['1/30/2024', 18.5],
                    ['1/31/2024', 17.0],
                    ['2/1/2024', 16.5],
                    ['2/2/2024', 18.0],
                    ['2/5/2024', 17.5],
                    ['2/6/2024', 16.5],
                    ['2/7/2024', 18.5],
                    ['2/8/2024', 17.0],
                    ['2/9/2024', 19.0],
                    ['2/12/2024', 18.0],
                    ['2/13/2024', 16.5],
                    ['2/14/2024', 17.5],
                    ['2/15/2024', 18.5],
                    ['2/16/2024', 17.0],
                    ['2/19/2024', 16.5],
                    ['2/20/2024', 18.0],
                    ['2/21/2024', 17.5],
                    ['2/22/2024', 19.0],
                    ['2/23/2024', 18.5],
                    ['2/26/2024', 17.0],
                    ['2/27/2024', 16.5],
                    ['2/28/2024', 18.0],
                    ['2/29/2024', 17.5],
                    ['3/1/2024', 16.5]


                ]
            }
        ]
    });


}

function timeToDecimal(time) {
    const date = new Date(`2000-01-01T${time}`);
    return date.getHours() + date.getMinutes() / 60;
}

function getDernierCours(events) {
    let cours = {};
    let allGroups = new Set();

    events.forEach(event => {
        let date = new Date(event.start).toLocaleDateString();
        if (!cours[date]) {
            cours[date] = {};
        }
        
        event.groups.forEach(group => {
            // VÃ©rification du groupe
            if (!['BUT1-G1', 'BUT1-G21', 'BUT1-G22', 'BUT1-G3', 'BUT2-G1', 'BUT2-G21', 'BUT2-G22', 'BUT2-G3', 'BUT3-G1', 'BUT3-G21', 'BUT3-G22', 'BUT3-G3'].includes(group)) {
                console.log(group);
                return; // Ignorer ce groupe
            }

            allGroups.add(group);
            let groupEndTime = new Date(event.end).toLocaleTimeString();
            let decimalEndTime = timeToDecimal(groupEndTime);
            if (!cours[date][group] || decimalEndTime > timeToDecimal(cours[date][group])) {
                cours[date][group] = decimalEndTime;
            }
        });
    });

    // Convertir l'objet cours en tableau
    let tab = [];
    for (let date in cours) {
        let row = [date];
        allGroups.forEach(group => {
            row.push(cours[date][group] || "0");
        });
        tab.push(row);
    }

    renderTimes(tab);
}

console.log(getDernierCours(all))

function handlerClick(ev) {
    if (ev.target.id == 'group') {
        let result;
        if (ev.target.value == "tout") {
            result = all;
        }
        else {
            result = M.filterByTag("group", ev.target.value);
        }
        renderTimes(result);
    }

    if (ev.target.id == 'week') {
        let result;
        result = M.filterByTag("week", ev.target.value);
        getDernierCours(result);
    }
}

export { handlerClick };